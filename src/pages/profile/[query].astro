---
import { isValidAddress } from "algosdk";
import Layout from "@/layouts/Layout.astro";
import Page from "@/layouts/Page.astro";

import { shortenAddress } from "@/functions";
import { getNFD } from "@/api";

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";

import { ProfilePageIsland } from "@/recipes";

interface Props {
  query: string;
}
let { query } = Astro.params;

if (!query || (!query.includes(".algo") && !isValidAddress(query))) {
  const error = await fetch(`${Astro.url}/404`);
  return new Response(error.body, {
    headers: error.headers,
    status: 404,
    statusText: "Not Found",
  });
}

let isNfdQuery = query.includes(".algo");
let hasNfd = false;
let address = query;

try {
  const nfd = await getNFD(query);
  query = nfd.name;
  if (isNfdQuery) {
    address = nfd.owner;
  }
  hasNfd = true;
  console.log("NFD found:", nfd);
} catch (e) {
  console.log(e);
}
---

<Layout
  title={`Profile: ${hasNfd ? query : address}`}
  description="xGov Profile Page"
>
  <Page>
    <Breadcrumb slot="breadcrumb">
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href="/">Home</BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbPage>Profile</BreadcrumbPage>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          {
            !!address && (
              <>
                <BreadcrumbPage className="hidden md:inline">
                  {hasNfd ? query : address}
                </BreadcrumbPage>
                <BreadcrumbPage className="inline md:hidden">
                  {hasNfd ? query : shortenAddress(address)}
                </BreadcrumbPage>
              </>
            )
          }
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>
    <ProfilePageIsland client:only="react" address={address} />
  </Page>
</Layout>
